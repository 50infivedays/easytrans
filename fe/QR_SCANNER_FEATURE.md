# 二维码扫描功能

## 功能概述

在WebDrop应用中新增了二维码扫描功能，用户可以通过扫描对方的UID二维码来快速建立连接，无需手动输入UID。

## 功能特性

### 1. 二维码扫描
- 使用`@yudiel/react-qr-scanner`库实现
- 支持摄像头权限请求
- 实时扫描识别二维码
- 自动填充UID到连接输入框

### 2. 用户界面
- 在连接区域添加了"扫描"按钮
- 扫描按钮仅在未连接状态下显示
- 支持中英文界面
- 美观的扫描界面，包含扫描框指示

### 3. 权限处理
- **主动权限请求**：点击"开始扫描"时主动请求摄像头权限
- **权限状态指示**：显示当前权限状态和错误信息
- **详细错误处理**：区分不同类型的权限错误
  - `NotAllowedError`：权限被拒绝
  - `NotFoundError`：未找到摄像头设备
  - `NotSupportedError`：设备不支持摄像头
  - `NotReadableError`：摄像头被其他应用占用
- **用户友好提示**：清晰的权限状态和操作指引

### 4. 移动端优化
- **HTTPS环境检查**：移动端要求HTTPS环境，自动检测并提示
- **移动端检测**：自动识别移动设备并提供相应提示
- **详细错误信息**：针对移动端提供更具体的错误说明
- **权限流程优化**：适配移动端权限请求机制

### 5. 用户反馈
- **扫描成功提示**：扫描成功后显示toast消息
- **多语言支持**：toast消息支持中英文
- **即时反馈**：用户操作后立即获得反馈

### 6. 错误处理
- 摄像头权限失败提示
- 扫描错误处理
- 用户友好的错误信息

## 使用方法

1. **启动扫描**：点击连接区域的"扫描"按钮
2. **权限授权**：允许浏览器访问摄像头（首次使用）
3. **扫描二维码**：将对方的UID二维码对准摄像头
4. **成功反馈**：扫描成功后显示toast提示
5. **自动连接**：UID会自动填入，点击"连接"即可

## 技术实现

### 组件结构
```
QRScanner (fe/src/components/ui/qrscanner.tsx)
├── Scanner (@yudiel/react-qr-scanner)
├── Dialog (自定义对话框)
└── Button (控制按钮)
```

### 主要功能
- `handleQRScan`: 处理扫描结果
- `setShowQRScanner`: 控制扫描器显示/隐藏
- `handleStartScan`: 主动请求摄像头权限并开始扫描
- 自动清理扫描结果并转换为大写

### 权限处理机制
1. **Scanner组件始终渲染**：通过`paused`属性控制扫描状态
2. **主动权限请求**：在用户点击"开始扫描"时调用`getUserMedia`
3. **权限状态管理**：使用`hasPermission`状态跟踪权限状态
4. **错误分类处理**：根据错误类型显示不同的提示信息
5. **移动端适配**：检测移动设备并提供相应的权限处理

### Toast反馈机制
1. **扫描成功提示**：扫描成功后立即显示toast消息
2. **多语言支持**：根据当前语言显示相应的提示文本
3. **用户友好**：提供即时的操作反馈

### API适配
- 使用`Scanner`组件而不是`QrScanner`
- 使用`onScan`回调而不是`onDecode`
- 处理`IDetectedBarcode[]`数组格式的扫描结果
- 指定`formats={['qr_code']}`只扫描二维码

### 翻译支持
- 中文：扫描、二维码扫描成功、二维码扫描成功！
- 英文：Scan、QR code scanned successfully、QR code scanned successfully!

## 依赖项

```json
{
  "@yudiel/react-qr-scanner": "^2.3.1"
}
```

## 浏览器兼容性

- 需要支持WebRTC的现代浏览器
- 需要摄像头权限
- 支持HTTPS环境（摄像头访问要求）

## 注意事项

1. **HTTPS要求**：摄像头访问需要HTTPS环境
2. **权限管理**：首次使用需要用户授权摄像头权限
3. **移动设备**：在移动设备上效果最佳
4. **网络连接**：需要WebSocket连接正常才能使用扫描功能

## 修复的问题

1. **API兼容性**：修复了`@yudiel/react-qr-scanner`的API使用方式
   - 使用`Scanner`而不是`QrScanner`
   - 使用`onScan`而不是`onDecode`
   - 正确处理扫描结果数组格式

2. **Dialog组件增强**：修改了Dialog组件以支持children和自定义操作按钮
   - 添加了`children`属性支持
   - 添加了`showActions`属性控制是否显示默认操作按钮
   - 使`onConfirm`和`onCancel`变为可选属性

3. **权限处理改进**：
   - 主动请求摄像头权限而不是被动等待
   - 添加权限状态指示器
   - 详细的错误分类和处理
   - 用户友好的权限状态提示

4. **移动端优化**：
   - 添加HTTPS环境检查
   - 移动端设备检测
   - 针对移动端的错误提示
   - 详细的调试日志输出

5. **用户反馈增强**：
   - 扫描成功后显示toast提示
   - 多语言toast消息支持
   - 即时的用户操作反馈 